// =====================================================================
// web_ui.ino — WEB SERVER HTML + ROUTE HANDLERS (Corrected)
// =====================================================================

// =====================================================================
// WEB SERVER ROUTES (unchanged, but ensure server object is declared)
// =====================================================================
void setupWebServer() {
  server.on("/", []() { server.send(200, "text/html", getHTML()); });

  // Status endpoint for polling
  server.on("/api/status", []() {
    String json = "{";
    json += "\"currentPage\":" + String(currentPage) + ",";
    json += "\"currentEffect\":" + String(currentEffect) + ",";
    json += "\"customColorMode\":" + String(customColorMode ? "true" : "false") + ",";
    json += "\"headHue\":" + String(headHue) + ",";
    json += "\"headSat\":" + String(headSat) + ",";
    json += "\"headVal\":" + String(headVal) + ",";
    json += "\"tailHue\":" + String(tailHue) + ",";
    json += "\"effectEnabled\":" + String(effectEnabled ? "true" : "false") + ",";
    json += "\"blackout\":" + String(blackout ? "true" : "false");
    json += "}";
    server.send(200, "application/json", json);
  });

  server.on("/seteffect", []() {
    if (server.hasArg("page") && server.hasArg("effect")) {
      int p = server.arg("page").toInt(), e = server.arg("effect").toInt();
      int maxE = 5;
      if (p == 0) maxE = 6;   // Page 1: 6 effects
      if (p == 3) maxE = 10;  // Page 4: 10 effects
      if (p == 5) maxE = 14;  // Page 6: 14 effects
      if (p >= 0 && p < NUM_PAGES && e >= 0 && e < maxE) { currentPage = p; currentEffect = e; }
    }
    server.send(200, "text/plain", "OK");
  });

  server.on("/setbrightness", []() {
    if (server.hasArg("v")) {
      globalBrightness = server.arg("v").toInt();
      FastLED.setBrightness(globalBrightness);
    }
    server.send(200, "text/plain", "OK");
  });

  server.on("/togglecustom", []() {
    if (server.hasArg("state")) {
      bool newMode = (server.arg("state") == "1");
      if (newMode && !customColorMode) initCustomColorMode();
      customColorMode = newMode;
    } else {
      customColorMode = !customColorMode;
      if (customColorMode) initCustomColorMode();
    }
    server.send(200, "text/plain", "OK");
  });

  server.on("/setheadcolor", []() {
    if (server.hasArg("h")) headHue = server.arg("h").toInt();
    if (server.hasArg("s")) headSat = server.arg("s").toInt();
    if (server.hasArg("v")) headVal = server.arg("v").toInt();
    server.send(200, "text/plain", "OK");
  });

  server.on("/settailcolor", []() {
    if (server.hasArg("h")) tailHue = server.arg("h").toInt();
    if (server.hasArg("s")) tailSat = server.arg("s").toInt();
    if (server.hasArg("v")) tailVal = server.arg("v").toInt();
    server.send(200, "text/plain", "OK");
  });

  server.on("/toggleeffect", []() {
    effectEnabled = !effectEnabled;
    server.send(200, "text/plain", "OK");
  });

  server.on("/toggleblackout", []() {
    blackout = !blackout;
    if (blackout) { FastLED.clear(); FastLED.show(); }
    server.send(200, "text/plain", "OK");
  });

  server.on("/addgradientstop", []() {
    if (numGradientStops >= MAX_GRADIENT_STOPS) {
      server.send(200, "text/plain", "MAX");
      return;
    }
    if (server.hasArg("pos") && server.hasArg("h") && server.hasArg("s") && server.hasArg("v")) {
      gradientStops[numGradientStops].position = server.arg("pos").toFloat();
      gradientStops[numGradientStops].hue = server.arg("h").toInt();
      gradientStops[numGradientStops].sat = server.arg("s").toInt();
      gradientStops[numGradientStops].val = server.arg("v").toInt();
      numGradientStops++;
      // Sort gradient stops by position
      for (int i = 0; i < numGradientStops - 1; i++) {
        for (int j = i + 1; j < numGradientStops; j++) {
          if (gradientStops[i].position > gradientStops[j].position) {
            GradientStop temp = gradientStops[i];
            gradientStops[i] = gradientStops[j];
            gradientStops[j] = temp;
          }
        }
      }
    }
    server.send(200, "text/plain", "OK");
  });

  server.on("/cleargradient", []() {
    numGradientStops = 2;
    gradientStops[0].position = 0.0f;
    gradientStops[1].position = 1.0f;
    server.send(200, "text/plain", "OK");
  });

  server.on("/setaudio", []() {
    lastWebAudio = millis();
    if (server.hasArg("level")) {
      int level = server.arg("level").toInt();
      audioLevel = level / 255.0f;
    }
    if (server.hasArg("bass")) {
      int bass = server.arg("bass").toInt();
      audioBass = bass / 255.0f;
      audioEnergy = audioBass;
    }
    if (server.hasArg("midlow")) {
      audioMidLow = server.arg("midlow").toInt() / 255.0f;
    }
    if (server.hasArg("mid")) {
      audioMid = server.arg("mid").toInt() / 255.0f;
    }
    if (server.hasArg("high")) {
      audioHigh = server.arg("high").toInt() / 255.0f;
    }
    if (server.hasArg("beat")) {
      pseudoBeat = (server.arg("beat") == "1");
      if (server.hasArg("strength")) {
        beatIntensity = server.arg("strength").toInt() / 255.0f;
      } else if (pseudoBeat) {
        beatIntensity = 0.8f;
      }
    }
    server.send(200, "text/plain", "OK");
  });

  server.on("/setaudiomode", []() {
    server.send(200, "text/plain", "OK");
  });

  server.begin();
}

// =====================================================================
// OTA SETUP (unchanged)
// =====================================================================
void setupOTA() {
  ArduinoOTA.setHostname(hostname);
  ArduinoOTA.setPassword(otaPassword);
  ArduinoOTA.onStart([]() { otaInProgress = true; fill_solid(leds, NUM_LEDS, CRGB(150, 0, 200)); FastLED.show(); });
  ArduinoOTA.onEnd([]() { otaInProgress = false; fill_solid(leds, NUM_LEDS, CRGB::Green); FastLED.show(); });
  ArduinoOTA.onProgress([](unsigned int prog, unsigned int total) {
    int n = (prog * NUM_LEDS) / total;
    for (int i = 0; i < NUM_LEDS; i++) leds[i] = (i < n) ? CRGB::Blue : CRGB::Purple;
    FastLED.show();
  });
  ArduinoOTA.begin();
}

// =====================================================================
// HTML GENERATION (using F() macros and concatenation)
// =====================================================================
String getHTML() {
  String html = F("<!DOCTYPE html><html lang=\"en\"><head><meta charset=\"UTF-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1,user-scalable=no\"><title>Petal Flow Control</title><link href=\"https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap\" rel=\"stylesheet\"><style>:root{--bg-deep:#0a0c10;--bg-card:#12151c;--bg-elevated:#1a1e28;--border:rgba(255,255,255,0.06);--text-primary:#f0f2f5;--text-secondary:#7a8494;--text-muted:#4a5260;--accent:#00d4aa;--accent-glow:rgba(0,212,170,0.4);--accent-dim:#00a080;--danger:#ff4757;--custom-mode:#f59e0b}*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}body{font-family:'Space Grotesk',sans-serif;background:var(--bg-deep);min-height:100vh;min-height:100dvh;color:var(--text-primary);overflow-x:hidden}.bg-glow{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:0}.bg-glow::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 30% 20%,var(--accent-glow) 0,transparent 50%),radial-gradient(ellipse at 70% 80%,rgba(80,60,200,.15) 0,transparent 50%);animation:bgShift 20s ease-in-out infinite}.bg-glow.custom-mode::before{background:radial-gradient(ellipse at 30% 20%,rgba(245,158,11,.3) 0,transparent 50%),radial-gradient(ellipse at 70% 80%,rgba(251,191,36,.15) 0,transparent 50%)}@keyframes bgShift{0%,100%{transform:translate(0) rotate(0)}33%{transform:translate(2%,1%) rotate(1deg)}66%{transform:translate(-1%,2%) rotate(-1deg)}}.app{position:relative;z-index:1;max-width:420px;margin:0 auto;padding:1rem;min-height:100vh;min-height:100dvh}.header{display:flex;align-items:center;justify-content:space-between;padding:.5rem 0;margin-bottom:.75rem}.logo{display:flex;align-items:center;gap:.5rem}.logo-icon{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-dim));display:flex;align-items:center;justify-content:center;transition:background .3s}.logo-icon.custom-mode{background:linear-gradient(135deg,var(--custom-mode),#d97706)}.logo-icon svg{width:18px;height:18px;stroke:var(--bg-deep);stroke-width:2.5;fill:none}.logo-text{font-weight:700;font-size:1.1rem;letter-spacing:-.5px}.mode-badge{font-size:.55rem;font-weight:700;padding:.25rem .5rem;border-radius:6px;text-transform:uppercase;letter-spacing:.5px;background:var(--bg-elevated);color:var(--text-muted);border:1px solid var(--border);transition:all .3s}.mode-badge.custom-mode{background:var(--custom-mode);color:var(--bg-deep);border-color:transparent}.staff-visual{background:var(--bg-card);border-radius:16px;padding:1rem;margin-bottom:.75rem;border:1px solid var(--border);position:relative;overflow:hidden}.staff-label{font-size:.6rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:.5rem;display:flex;justify-content:space-between;align-items:center}.staff-mode-indicator{font-size:.55rem;padding:.15rem .4rem;border-radius:4px;background:var(--bg-elevated);color:var(--text-secondary)}.staff-mode-indicator.custom{background:var(--custom-mode);color:var(--bg-deep)}.staff-container{display:flex;align-items:center;justify-content:center;gap:0;padding:.5rem 0;min-height:100px}.flower-end{width:70px;height:70px;position:relative;flex-shrink:0}.flower-svg{width:100%;height:100%;filter:drop-shadow(0 0 15px var(--flower-color,var(--accent)));transition:filter .3s}.flower-petal{fill:var(--flower-color,var(--accent));transition:fill .3s;stroke:rgba(255,255,255,.2);stroke-width:.5}.flower-center{fill:rgba(0,0,0,.4)}.staff-middle{flex:1;height:36px;background:var(--bg-elevated);border-radius:4px;position:relative;overflow:hidden;margin:0 -2px;min-width:80px}.staff-pattern{position:absolute;inset:0}.staff-pattern canvas{width:100%;height:100%}.staff-info{display:flex;justify-content:space-between;margin-top:.5rem;font-size:.6rem;font-family:'JetBrains Mono',monospace}.staff-info-item{display:flex;align-items:center;gap:.3rem;color:var(--text-muted)}.staff-info-item span:first-child{width:8px;height:8px;border-radius:50%}.mode-toggle{display:flex;gap:.5rem;margin-bottom:.75rem}.mode-btn{flex:1;padding:.6rem;border-radius:10px;font-size:.7rem;font-weight:600;font-family:'Space Grotesk',sans-serif;cursor:pointer;transition:all .2s;border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;justify-content:center;gap:.4rem}.mode-btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2}.mode-btn:hover{background:var(--bg-elevated);border-color:rgba(255,255,255,.1)}.mode-btn.active{border-color:transparent}.mode-btn.effects.active{background:var(--accent);color:var(--bg-deep);box-shadow:0 4px 15px var(--accent-glow)}.mode-btn.custom.active{background:var(--custom-mode);color:var(--bg-deep);box-shadow:0 4px 15px rgba(245,158,11,.4)}.effects-section{background:var(--bg-card);border-radius:14px;padding:.85rem;margin-bottom:.75rem;border:1px solid var(--border)}.effects-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;gap:.5rem;flex-wrap:wrap}.effects-title{font-size:.65rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}.page-nav{display:flex;gap:.25rem}.page-tab{padding:.3rem .55rem;background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;font-size:.6rem;font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all .2s;white-space:nowrap}.page-tab:hover{background:var(--bg-deep);color:var(--text-primary)}.page-tab.active{background:var(--accent);border-color:var(--accent);color:var(--bg-deep)}.effects-count{font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--text-secondary);background:var(--bg-elevated);padding:.2rem .45rem;border-radius:6px}.effects-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.4rem}.effect-btn{position:relative;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;padding:.55rem .35rem;font-size:.65rem;font-weight:600;font-family:'Space Grotesk',sans-serif;color:var(--text-secondary);cursor:pointer;transition:all .2s;overflow:hidden}.effect-btn::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--effect-head,var(--accent))}.effect-btn::after{content:'';position:absolute;right:0;top:0;bottom:0;width:3px;background:var(--effect-tail,var(--accent-dim))}.effect-btn:hover{background:var(--bg-deep);border-color:rgba(255,255,255,.1);color:var(--text-primary);transform:translateY(-1px)}.effect-btn.active{background:linear-gradient(135deg,var(--effect-head,var(--accent)),var(--effect-tail,var(--accent-dim)));border-color:transparent;color:var(--bg-deep);box-shadow:0 3px 12px var(--accent-glow)}.effect-btn.active::before,.effect-btn.active::after{width:0}.custom-section{background:var(--bg-card);border-radius:14px;padding:.85rem;margin-bottom:.75rem;border:1px solid var(--border);display:none}.custom-section.visible{display:block}.custom-title{font-size:.65rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:.5rem}.custom-staff-preview{display:flex;align-items:center;justify-content:center;margin-bottom:.75rem;padding:.5rem;background:rgba(0,0,0,.2);border-radius:12px}.custom-flower{width:50px;height:50px;flex-shrink:0}.custom-middle{flex:1;height:24px;background:var(--bg-elevated);border-radius:4px;margin:0 -2px;position:relative;overflow:hidden}#customPreviewCanvas{width:100%;height:100%}.head-tail-picker{display:flex;align-items:center;gap:.75rem;padding:.75rem;background:var(--bg-elevated);border-radius:10px;margin-bottom:.75rem}.color-picker-area{flex:1}.picker-label{font-size:.6rem;color:var(--text-muted);margin-bottom:.3rem;text-transform:uppercase;letter-spacing:.5px}.hue-slider-container{position:relative;height:24px;border-radius:12px;background:linear-gradient(90deg,red,#ff0,#0f0,#0ff,#00f,#f0f,red);cursor:pointer}.hue-thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:20px;height:20px;border-radius:50%;background:var(--custom-color,var(--custom-mode));border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.4);pointer-events:none}.controls-section{background:var(--bg-card);border-radius:14px;padding:.85rem;margin-bottom:.75rem;border:1px solid var(--border)}.control-row{display:flex;align-items:center;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid var(--border)}.control-row:last-child{border-bottom:none}.control-label{font-size:.7rem;font-weight:500;color:var(--text-primary)}.control-desc{font-size:.55rem;color:var(--text-muted);margin-top:.1rem}.toggle-switch{display:flex;background:var(--bg-elevated);border-radius:6px;overflow:hidden;border:1px solid var(--border)}.toggle-option{padding:.35rem .7rem;font-size:.65rem;font-weight:600;font-family:'JetBrains Mono',monospace;color:var(--text-muted);cursor:pointer;transition:all .2s;border:none;background:transparent}.toggle-option.active{background:var(--accent);color:var(--bg-deep)}.main-toggle{display:flex;gap:.4rem;margin-top:.4rem}.main-toggle-btn{flex:1;padding:.6rem;border-radius:8px;font-size:.65rem;font-weight:600;font-family:'Space Grotesk',sans-serif;cursor:pointer;transition:all .2s;border:1px solid var(--border);background:var(--bg-elevated);color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px}.main-toggle-btn:hover{border-color:rgba(255,255,255,.1)}.main-toggle-btn.on.active{background:var(--accent);color:var(--bg-deep);border-color:transparent;box-shadow:0 3px 15px var(--accent-glow)}.main-toggle-btn.blackout.active{background:var(--danger);color:#fff;border-color:transparent;box-shadow:0 3px 15px rgba(255,71,87,.4)}.firmware-btn{width:100%;padding:.7rem;background:linear-gradient(135deg,var(--bg-elevated),var(--bg-card));border:1px solid var(--border);border-radius:10px;color:var(--text-primary);font-size:.7rem;font-weight:600;font-family:'Space Grotesk',sans-serif;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.5rem;transition:all .2s;margin-bottom:.75rem}.firmware-btn:hover{background:var(--bg-elevated);border-color:var(--accent)}.firmware-btn svg{width:14px;height:14px;stroke:var(--accent)}.status-bar{display:flex;justify-content:space-between;align-items:center;padding:.5rem .7rem;background:var(--bg-card);border-radius:10px;border:1px solid var(--border);font-size:.6rem;font-family:'JetBrains Mono',monospace}.status-left{display:flex;align-items:center;gap:.35rem;color:var(--text-muted)}.status-page{background:var(--bg-elevated);padding:.2rem .4rem;border-radius:4px;color:var(--text-secondary)}.status-effect{color:var(--accent);font-weight:500;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.status-effect.custom{color:var(--custom-mode)}.instructions{text-align:center;margin-top:.6rem;font-size:.55rem;color:var(--text-muted);letter-spacing:.3px}.file-input{display:none}@media (max-width:360px){.effects-grid{grid-template-columns:repeat(2,1fr)}.flower-end{width:60px;height:60px}.custom-flower{width:40px;height:40px}}@media (prefers-reduced-motion:reduce){*,::before,::after{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}}</style></head><body><div class=\"bg-glow\" id=\"bgGlow\"></div><div class=\"app\"><header class=\"header\"><div class=\"logo\"><div class=\"logo-icon\" id=\"logoIcon\"><svg viewBox=\"0 0 24 24\"><path d=\"M12 2L12 22M12 2L8 6M12 2L16 6M12 22L8 18M12 22L16 18\"/></svg></div><span class=\"logo-text\">Petal Flow</span></div><div><span class=\"mode-badge\" id=\"modeBadge\">Effects Mode</span></div></header><div class=\"staff-visual\"><div class=\"staff-label\"><span>Live Preview</span><span class=\"staff-mode-indicator\" id=\"staffModeIndicator\">Effect</span></div><div class=\"staff-container\"><div class=\"flower-end\" id=\"flowerHead\"></div><div class=\"staff-middle\"><div class=\"staff-pattern\"><canvas id=\"patternCanvas\"></canvas></div></div><div class=\"flower-end\" id=\"flowerTail\"></div></div><div class=\"staff-info\"><div class=\"staff-info-item\"><span id=\"headSwatch\"></span>Head</div><div class=\"staff-info-item\">Center Pattern</div><div class=\"staff-info-item\">Tail<span id=\"tailSwatch\"></span></div></div></div><div class=\"mode-toggle\"><button class=\"mode-btn effects active\" id=\"effectsModeBtn\"><svg viewBox=\"0 0 24 24\"><polygon points=\"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2\"/></svg>Effects</button><button class=\"mode-btn custom\" id=\"customModeBtn\"><svg viewBox=\"0 0 24 24\"><circle cx=\"13.5\" cy=\"6.5\" r=\"2.5\"/><circle cx=\"17.5\" cy=\"10.5\" r=\"2.5\"/><circle cx=\"8.5\" cy=\"7.5\" r=\"2.5\"/><circle cx=\"6.5\" cy=\"12.5\" r=\"2.5\"/><path d=\"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.93 0 1.82-.13 2.67-.35\"/></svg>Custom Color</button></div><section class=\"effects-section\" id=\"effectsSection\"><div class=\"effects-header\"><span class=\"effects-title\">Effects</span><div class=\"page-nav\" id=\"pageNav\"></div><span class=\"effects-count\" id=\"effectsCount\">1 of 6</span></div><div class=\"effects-grid\" id=\"effectsGrid\"></div></section><section class=\"custom-section\" id=\"customSection\"><div class=\"custom-title\">Custom Solid Color Mode</div><div class=\"custom-staff-preview\"><div class=\"custom-flower\" id=\"customFlowerHead\"></div><div class=\"custom-middle\"><canvas id=\"customPreviewCanvas\"></canvas></div><div class=\"custom-flower\" id=\"customFlowerTail\"></div></div><div class=\"custom-title\" style=\"margin-top:1rem\">Head & Tail Color</div><div class=\"head-tail-picker\"><div class=\"color-picker-area\" style=\"width:100%\"><div class=\"picker-label\">Hue <span id=\"hueValue\">220</span></div><div class=\"hue-slider-container\" id=\"headTailHueBar\"><div class=\"hue-thumb\" id=\"headTailHueThumb\"></div></div></div></div><div class=\"head-tail-picker\"><div class=\"color-picker-area\" style=\"width:100%\"><div class=\"picker-label\">Saturation <span id=\"satValue\">200</span></div><div class=\"hue-slider-container\" id=\"headTailSatBar\" style=\"background:linear-gradient(90deg,#808080,hsl(220,100%,50%))\"><div class=\"hue-thumb\" id=\"headTailSatThumb\"></div></div></div></div><div class=\"head-tail-picker\"><div class=\"color-picker-area\" style=\"width:100%\"><div class=\"picker-label\">Brightness <span id=\"valValue\">220</span></div><div class=\"hue-slider-container\" id=\"headTailValBar\" style=\"background:linear-gradient(90deg,#000,hsl(220,100%,50%))\"><div class=\"hue-thumb\" id=\"headTailValThumb\"></div></div></div></div><div class=\"custom-title\" style=\"margin-top:1rem\">Staff Gradient <span style=\"font-size:.5rem;color:var(--text-muted)\">(Head to Tail)</span></div><div class=\"head-tail-picker\"><div class=\"color-picker-area\" style=\"width:100%\"><div class=\"picker-label\">Staff Position (0=Head, 100=Tail) <span id=\"staffPosValue\">50</span></div><div class=\"hue-slider-container\" id=\"staffPosBar\" style=\"background:linear-gradient(90deg,var(--accent-dim),var(--accent))\"><div class=\"hue-thumb\" id=\"staffPosThumb\" style=\"left:50%\"></div></div></div></div><div class=\"head-tail-picker\"><div class=\"color-picker-area\" style=\"width:100%\"><div class=\"picker-label\">Staff Color Hue <span id=\"staffHueValue\">180</span></div><div class=\"hue-slider-container\" id=\"staffHueBar\"><div class=\"hue-thumb\" id=\"staffHueThumb\"></div></div></div></div><div style=\"display:flex;gap:.5rem;margin-top:.5rem\"><button class=\"mode-btn effects\" style=\"flex:1\" id=\"addStopBtn\">+ Add Color</button><button class=\"mode-btn effects\" style=\"flex:1\" id=\"clearStopsBtn\">Reset Gradient</button></div></section><section class=\"controls-section\"><div class=\"control-row\"><div><div class=\"control-label\">Brightness</div><div class=\"control-desc\">70% = 180 / 100% = 255</div></div><div class=\"toggle-switch\" id=\"brightnessToggle\"><button class=\"toggle-option active\" data-value=\"180\">70%</button><button class=\"toggle-option\" data-value=\"255\">100%</button></div></div><div class=\"control-row\"><div><div class=\"control-label\">Phone Microphone</div><div class=\"control-desc\">Use phone audio for reactive effects</div></div><div class=\"toggle-switch\" id=\"audioToggle\"><button class=\"toggle-option active\" id=\"audioOffBtn\">OFF</button><button class=\"toggle-option\" id=\"audioOnBtn\">ON</button></div></div><div id=\"audioMonitor\" style=\"display:none;margin-top:.5rem;padding:.5rem;background:var(--bg-elevated);border-radius:8px;font-size:.55rem;font-family:monospace\"><div style=\"margin-bottom:.25rem\">Audio Levels:</div><div style=\"display:flex;gap:.25rem;margin-bottom:.25rem\"><div style=\"flex:1\"><div style=\"font-size:.45rem;color:var(--text-muted)\">Bass</div><div style=\"height:20px;background:var(--bg-deep);border-radius:4px;overflow:hidden\"><div id=\"bassBar\" style=\"height:100%;background:#ff4757;width:0%;transition:width .1s\"></div></div></div><div style=\"flex:1\"><div style=\"font-size:.45rem;color:var(--text-muted)\">Mid</div><div style=\"height:20px;background:var(--bg-deep);border-radius:4px;overflow:hidden\"><div id=\"midBar\" style=\"height:100%;background:#5af78e;width:0%;transition:width .1s\"></div></div></div><div style=\"flex:1\"><div style=\"font-size:.45rem;color:var(--text-muted)\">High</div><div style=\"height:20px;background:var(--bg-deep);border-radius:4px;overflow:hidden\"><div id=\"highBar\" style=\"height:100%;background:#3498db;width:0%;transition:width .1s\"></div></div></div></div><div id=\"beatIndicator\" style=\"text-align:center;padding:.25rem;border-radius:4px;background:var(--bg-deep);color:var(--text-muted);transition:all .2s\">No beat</div></div><div class=\"main-toggle\"><button class=\"main-toggle-btn on active\" id=\"effectOn\">Effect On</button><button class=\"main-toggle-btn blackout\" id=\"blackout\">Blackout</button></div></section><label class=\"firmware-btn\" for=\"firmwareFile\"><svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"/><polyline points=\"17 8 12 3 7 8\"/><line x1=\"12\" y1=\"3\" x2=\"12\" y2=\"15\"/></svg>Update Firmware</label><input type=\"file\" id=\"firmwareFile\" class=\"file-input\" accept=\".bin\"><div class=\"status-bar\"><div class=\"status-left\"><span class=\"status-page\" id=\"statusPage\">P1</span><span id=\"statusIndex\">1/6</span></div><span class=\"status-effect\" id=\"statusEffect\">Purple Blob</span><span style=\"color:var(--text-muted)\">");
  html += WiFi.localIP().toString();
  html += F("</span></div><div class=\"instructions\">Hue slider sets both head and tail colour. Phone audio requires HTTPS (use mDNS: purplestaff.local)</div></div><script>");
  html += F("const a='<svg class=\"flower-svg\" viewBox=\"0 0 100 100\"><g class=\"petals-group\"><path class=\"flower-petal\" d=\"M50,50 C35,35 35,10 50,0 C65,10 65,35 50,50 Z\" transform=\"rotate(0 50 50)\"/><path class=\"flower-petal\" d=\"M50,50 C35,35 35,10 50,0 C65,10 65,35 50,50 Z\" transform=\"rotate(72 50 50)\"/><path class=\"flower-petal\" d=\"M50,50 C35,35 35,10 50,0 C65,10 65,35 50,50 Z\" transform=\"rotate(144 50 50)\"/><path class=\"flower-petal\" d=\"M50,50 C35,35 35,10 50,0 C65,10 65,35 50,50 Z\" transform=\"rotate(216 50 50)\"/><path class=\"flower-petal\" d=\"M50,50 C35,35 35,10 50,0 C65,10 65,35 50,50 Z\" transform=\"rotate(288 50 50)\"/></g><circle class=\"flower-center\" cx=\"50\" cy=\"50\" r=\"8\"/></svg>',b=[{id:1,name:'Purple & Elemental',effects:[{name:'Purple Blob',head:'#9b59b6'},{name:'Rainbow Painter',head:'#ff6b6b'},{name:'Fire Storm',head:'#ff8c42'},{name:'Ocean Waves',head:'#4aa3ff'},{name:'Crystal Pulse',head:'#ff6b9d'},{name:'Ping Pong',head:'#f9d56e'}]},{id:2,name:'Audio Reactive',effects:[{name:'Audio Pulse',head:'#845ec2'},{name:'Beat Sparkle',head:'#ffc75f'},{name:'Sound Wave',head:'#2c73d2'},{name:'Color Shift',head:'#b39cd0'},{name:'Audio Fire',head:'#ff5e78'}]},{id:3,name:'Cosmic',effects:[{name:'Plasma Storm',head:'#a178df'},{name:'Lightning Strike',head:'#f9f3b0'},{name:'Comet Trail',head:'#ff9671'},{name:'Aurora Flow',head:'#6cd4c5'},{name:'Galaxy Swirl',head:'#8b6eb0'}]},{id:4,name:'Nature & Scenes',effects:[{name:'Ocean Breeze',head:'#4c9a8a'},{name:'Sunset Fade',head:'#ff9671'},{name:'Forest Mist',head:'#6d9773'},{name:'Aurora Dreams',head:'#a186be'},{name:'Lava Flow',head:'#e15554'},{name:'Smokey Cloudstorm',head:'#8899aa'},{name:'Dandelion Seeds',head:'#f5e6a0'},{name:'Tulip Bouquet',head:'#ff6b8a'},{name:'Space Rocket',head:'#4080ff'},{name:'Pumpkin Patch',head:'#ff8833'}]},{id:5,name:'Fruity',effects:[{name:'Watermelon',head:'#fc4a4a'},{name:'Citrus Burst',head:'#ffaa33'},{name:'Berry Blast',head:'#a55c9e'},{name:'Mango Swirl',head:'#ffb347'},{name:'Kiwi Spark',head:'#7fb07f'}]},{id:6,name:'Physics & Science',effects:[{name:'Newton Cradle',head:'#b0c4de'},{name:'Slinky',head:'#9370db'},{name:'Ink Drop',head:'#4169e1'},{name:'Ripple Tank',head:'#5f9ea0'},{name:'Supernova',head:'#ff6347'},{name:'Bioluminescence',head:'#48d1cc'},{name:'Plasma Waves',head:'#ff00ff'},{name:'Electron Orbit',head:'#ffff00'},{name:'DNA Helix',head:'#00ffff'},{name:'Meteor Shower',head:'#ff8800'},{name:'Magnetic Pull',head:'#4488ff'},{name:'Solar Flare',head:'#ff6600'},{name:'Molecular Vibe',head:'#44ddaa'},{name:'Black Hole',head:'#8855ff'}]}];let c=0,d=0,e=!1,f=220,g=200,h=220,i=.5,j=180;const k=document.getElementById('bgGlow'),l=document.getElementById('logoIcon'),m=document.getElementById('modeBadge'),n=document.getElementById('staffModeIndicator'),o=document.getElementById('pageNav'),p=document.getElementById('effectsSection'),q=document.getElementById('effectsGrid'),r=document.getElementById('effectsCount'),s=document.getElementById('customSection'),t=document.getElementById('effectsModeBtn'),u=document.getElementById('customModeBtn'),v=document.getElementById('flowerHead'),w=document.getElementById('flowerTail'),x=document.getElementById('customFlowerHead'),y=document.getElementById('customFlowerTail'),z=document.getElementById('headSwatch'),A=document.getElementById('tailSwatch'),B=document.getElementById('statusPage'),C=document.getElementById('statusIndex'),D=document.getElementById('statusEffect'),E=document.getElementById('patternCanvas'),F=E.getContext('2d'),G=document.getElementById('customPreviewCanvas'),H=G.getContext('2d'),I=document.getElementById('headTailHueBar'),J=document.getElementById('headTailHueThumb'),K=document.getElementById('headTailSatBar'),L=document.getElementById('headTailSatThumb'),M=document.getElementById('headTailValBar'),N=document.getElementById('headTailValThumb'),O=document.getElementById('hueValue'),P=document.getElementById('satValue'),Q=document.getElementById('valValue'),R=document.getElementById('brightnessToggle'),S=document.getElementById('effectOn'),T=document.getElementById('blackout'),U=document.getElementById('audioOffBtn'),V=document.getElementById('audioOnBtn'),W=document.getElementById('staffPosBar'),X=document.getElementById('staffPosThumb'),Y=document.getElementById('staffPosValue'),Z=document.getElementById('staffHueBar'),$=document.getElementById('staffHueThumb'),_=document.getElementById('staffHueValue'),aa=document.getElementById('addStopBtn'),ab=document.getElementById('clearStopsBtn');let ac=null,ad=null,ae=null,af=!1,ag=null,ah=0,ai=0,aj=[];async function ak(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){alert('Microphone API not available. This requires HTTPS or localhost.');return}ac=new(window.AudioContext||window.webkitAudioContext);const al=await navigator.mediaDevices.getUserMedia({audio:!0});ae=ac.createMediaStreamSource(al);ad=ac.createAnalyser();ad.fftSize=256;ah=ad.frequencyBinCount;ag=new Uint8Array(ah);ae.connect(ad);af=!0;console.log('✓ Web Audio enabled - microphone active');am()}catch(al){console.error('Microphone access error:',al);af=!1;if(al.name==='NotAllowedError')alert('Microphone permission denied. Please allow microphone access in your browser settings.');else if(al.name==='NotFoundError')alert('No microphone found on this device.');else if(al.name==='NotSupportedError'){alert('HTTPS required for microphone access. Use https://');}else alert('Microphone error: '+al.message);}}function am(){if(!af||!ad)return;ad.getByteFrequencyData(ag);const al=Math.floor(ah*.08),an=Math.floor(ah*.18),ao=Math.floor(ah*.35),ap=Math.floor(ah*.65);let aq=0,ar=0,as=0,at=0,au=0;for(let av=0;av<ah;av++){const aw=ag[av];au+=aw;if(av<al)aq+=aw;else if(av<an)ar+=aw;else if(av<ao)as+=aw;else if(av<ap)at+=aw}const ax=Math.min(aq/(al*255)*2.5+.1,1),ay=Math.min(ar/((an-al)*255)*2.5+.1,1),az=Math.min(as/((ao-an)*255)*3+.15,1),aA=Math.min(at/((ap-ao)*255)*4+.2,1),aB=Math.min(au/(ah*255)*2+.1,1);aj.push(ax);if(aj.length>20)aj.shift();const aC=aj.reduce((aD,aE)=>aD+aE,0)/aj.length,aF=aj.reduce((aD,aE)=>aD+Math.pow(aE-aC,2),0)/aj.length,aG=aC+Math.sqrt(aF)*1.2,now=Date.now();let aH=!1,aI=0;if(ax>aG&&now-ai>200){aH=!0;aI=Math.min((ax-aC)/(aC+.01),1);ai=now}if(now-(window.lastAudioSend||0)>50){window.lastAudioSend=now;const aJ=new URLSearchParams({level:Math.round(aB*255),bass:Math.round(ax*255),midlow:Math.round(ay*255),mid:Math.round(az*255),high:Math.round(aA*255),beat:aH?1:0,strength:Math.round(aI*255)});fetch(`/setaudio?${aJ}`).catch(()=>{});const aK=document.getElementById('audioMonitor');if(aK&&af){aK.style.display='block';document.getElementById('bassBar').style.width=ax*100+'%';document.getElementById('midBar').style.width=az*100+'%';document.getElementById('highBar').style.width=aA*100+'%';const aL=document.getElementById('beatIndicator');if(aH){aL.textContent=`BEAT! (${Math.round(aI*100)}%)`;aL.style.background='#ff4757';aL.style.color='white'}else{aL.textContent='Listening...';aL.style.background='var(--bg-deep)';aL.style.color='var(--text-muted)'}}}requestAnimationFrame(am)}v.innerHTML=a;w.innerHTML=a;x.innerHTML=a;y.innerHTML=a;function aM(){o.innerHTML='';b.forEach((aN,aO)=>{const aP=document.createElement('button');aP.className=`page-tab ${aO===c?'active':''}`;aP.textContent=`P${aN.id}`;aP.onclick=()=>aQ(aO);o.appendChild(aP)})}function aR(){q.innerHTML='';const aN=b[c];aN.effects.forEach((aS,aT)=>{const aU=document.createElement('button');aU.className=`effect-btn ${aT===d?'active':''}`;aU.textContent=aS.name;aU.style.setProperty('--effect-head',aS.head);aU.style.setProperty('--effect-tail',aS.head);aU.onclick=()=>aV(aT);q.appendChild(aU)});r.textContent=`${d+1} of ${aN.effects.length}`}function aQ(aO){fetch(`/seteffect?page=${aO}&effect=0`);c=aO;d=0;document.querySelectorAll('.page-tab').forEach((aW,aX)=>{aW.classList.toggle('active',aX===aO)});aR();aY();aZ()}function aV(aT){fetch(`/seteffect?page=${c}&effect=${aT}`);d=aT;document.querySelectorAll('.effect-btn').forEach((aW,aX)=>{aW.classList.toggle('active',aX===aT)});r.textContent=`${aT+1} of ${b[c].effects.length}`;aY();aZ()}function ba(bb){return bb/255*360}function bc(bb){return Math.round(bb/360*255)}function bd(be){const bf=bc(be);fetch(`/setheadcolor?h=${bf}&s=255&v=220`);fetch(`/settailcolor?h=${bf}&s=255&v=220`)}t.addEventListener('click',()=>{fetch('/togglecustom?state=0');e=!1;t.classList.add('active');u.classList.remove('active');p.style.display='block';s.classList.remove('visible');k.classList.remove('custom-mode');l.classList.remove('custom-mode');m.classList.remove('custom-mode');m.textContent='Effects Mode';n.textContent='Effect';n.classList.remove('custom');aY();aZ()});u.addEventListener('click',()=>{fetch('/togglecustom?state=1');e=!0;u.classList.add('active');t.classList.remove('active');p.style.display='none';s.classList.add('visible');k.classList.add('custom-mode');l.classList.add('custom-mode');m.classList.add('custom-mode');m.textContent='Custom Mode';n.textContent='Custom';n.classList.add('custom');aY();aZ()});function bg(){let bh=!1;const bi=bj=>{const bk=I.getBoundingClientRect();let bl=bj-bk.left;bl=Math.max(0,Math.min(bl,bk.width));f=bl/bk.width*360;J.style.left=f/360*100+'%';const bm=bn(f,100,50);J.style.background=bm;O.textContent=Math.round(f*255/360);bd();aY();bo()};I.addEventListener('mousedown',bp=>{bh=!0;bi(bp.clientX)});I.addEventListener('touchstart',bp=>{bh=!0;bi(bp.touches[0].clientX)},{passive:!0});document.addEventListener('mousemove',bp=>{if(bh)bi(bp.clientX)});document.addEventListener('touchmove',bp=>{if(bh)bi(bp.touches[0].clientX)},{passive:!0});document.addEventListener('mouseup',()=>bh=!1);document.addEventListener('touchend',()=>bh=!1);let bq=!1;const br=bs=>{const bt=K.getBoundingClientRect();let bu=bs-bt.left;bu=Math.max(0,Math.min(bu,bt.width));g=Math.round(bu/bt.width*255);L.style.left=g/255*100+'%';const bv=bw(f*255/360,g,h);L.style.background=bv;P.textContent=g;bd();aY()};K.addEventListener('mousedown',bs=>{bq=!0;br(bs.clientX)});K.addEventListener('touchstart',bs=>{bq=!0;br(bs.touches[0].clientX)},{passive:!0});document.addEventListener('mousemove',bs=>{if(bq)br(bs.clientX)});document.addEventListener('touchmove',bs=>{if(bq)br(bs.touches[0].clientX)},{passive:!0});document.addEventListener('mouseup',()=>bq=!1);document.addEventListener('touchend',()=>bq=!1);let bx=!1;const by=bz=>{const bA=M.getBoundingClientRect();let bB=bz-bA.left;bB=Math.max(0,Math.min(bB,bA.width));h=Math.round(bB/bA.width*255);N.style.left=h/255*100+'%';const bC=bw(f*255/360,g,h);N.style.background=bC;Q.textContent=h;bd();aY()};M.addEventListener('mousedown',bz=>{bx=!0;by(bz.clientX)});M.addEventListener('touchstart',bz=>{bx=!0;by(bz.touches[0].clientX)},{passive:!0});document.addEventListener('mousemove',bz=>{if(bx)by(bz.clientX)});document.addEventListener('touchmove',bz=>{if(bx)by(bz.touches[0].clientX)},{passive:!0});document.addEventListener('mouseup',()=>bx=!1);document.addEventListener('touchend',()=>bx=!1);J.style.left=f/360*100+'%';J.style.background=bn(f,100,50);L.style.left=g/255*100+'%';N.style.left=h/255*100+'%';O.textContent=Math.round(f*255/360);P.textContent=g;Q.textContent=h;bo()}function bD(){let bE=!1;const bF=bG=>{const bH=W.getBoundingClientRect();let bI=bG-bH.left;bI=Math.max(0,Math.min(bI,bH.width));i=bI/bH.width;X.style.left=i*100+'%';Y.textContent=Math.round(i*100)};W.addEventListener('mousedown',bG=>{bE=!0;bF(bG.clientX)});W.addEventListener('touchstart',bG=>{bE=!0;bF(bG.touches[0].clientX)},{passive:!0});document.addEventListener('mousemove',bG=>{if(bE)bF(bG.clientX)});document.addEventListener('touchmove',bG=>{if(bE)bF(bG.touches[0].clientX)},{passive:!0});document.addEventListener('mouseup',()=>bE=!1);document.addEventListener('touchend',()=>bE=!1);let bJ=!1;const bK=bL=>{const bM=Z.getBoundingClientRect();let bN=bL-bM.left;bN=Math.max(0,Math.min(bN,bM.width));j=bN/bM.width*360;$.style.left=j/360*100+'%';const bO=bn(j,100,50);$.style.background=bO;_.textContent=Math.round(j*255/360)};Z.addEventListener('mousedown',bL=>{bJ=!0;bK(bL.clientX)});Z.addEventListener('touchstart',bL=>{bJ=!0;bK(bL.touches[0].clientX)},{passive:!0});document.addEventListener('mousemove',bL=>{if(bJ)bK(bL.clientX)});document.addEventListener('touchmove',bL=>{if(bJ)bK(bL.touches[0].clientX)},{passive:!0});document.addEventListener('mouseup',()=>bJ=!1);document.addEventListener('touchend',()=>bJ=!1);X.style.left='50%';$.style.left=j/360*100+'%';$.style.background=bn(j,100,50);Y.textContent='50';_.textContent=Math.round(j*255/360)}aa.addEventListener('click',()=>{const bP=Math.round(j*255/360);fetch(`/addgradientstop?pos=${i}&h=${bP}&s=${g}&v=${h}`)});ab.addEventListener('click',()=>{fetch('/cleargradient')});function bo(){const bQ=f*255/360,bR=bn(f,100,50);K.style.background=`linear-gradient(90deg,#808080,${bR})`;M.style.background=`linear-gradient(90deg,#000,${bR})`;L.style.background=bw(bQ,g,h);N.style.background=bw(bQ,g,h)}function bd(){const bQ=Math.round(f*255/360);fetch(`/setheadcolor?h=${bQ}&s=${g}&v=${h}`);fetch(`/settailcolor?h=${bQ}&s=${g}&v=${h}`)}R.addEventListener('click',bS=>{if(bS.target.classList.contains('toggle-option')){document.querySelectorAll('#brightnessToggle .toggle-option').forEach(bT=>bT.classList.remove('active'));bS.target.classList.add('active');fetch('/setbrightness?v='+bS.target.dataset.value)}});S.addEventListener('click',()=>{fetch('/toggleeffect');S.classList.add('active');T.classList.remove('active')});T.addEventListener('click',()=>{fetch('/toggleblackout');T.classList.add('active');S.classList.remove('active')});document.getElementById('audioToggle').addEventListener('click',async bS=>{if(!bS.target.classList.contains('toggle-option'))return;if(bS.target.id==='audioOnBtn'){if(!af){await ak();if(af){document.querySelectorAll('#audioToggle .toggle-option').forEach(bU=>bU.classList.remove('active'));bS.target.classList.add('active');fetch('/setaudiomode?enabled=1')}}}else if(bS.target.id==='audioOffBtn'){if(af&&ac){ac.close();af=!1;document.querySelectorAll('#audioToggle .toggle-option').forEach(bU=>bU.classList.remove('active'));bS.target.classList.add('active');fetch('/setaudiomode?enabled=0')}}});S.addEventListener('click',()=>{fetch('/toggleeffect');S.classList.add('active');T.classList.remove('active')});T.addEventListener('click',()=>{fetch('/toggleblackout');T.classList.add('active');S.classList.remove('active')});document.getElementById('firmwareFile').addEventListener('change',bS=>{const bV=bS.target.files[0];if(bV)console.log('Firmware file selected:',bV.name)});function bn(bW,bX,bY){bX/=100;bY/=100;const bZ=bX*Math.min(bY,1-bY),b_=b0=>{const b1=(b0+bW/30)%12,b2=bY-bZ*Math.max(Math.min(b1-3,9-b1,1),-1);return Math.round(255*b2).toString(16).padStart(2,'0')};return'#'+b_(0)+b_(8)+b_(4)}function bw(b3,b4,b5){let b6=b3/255*360,b7=b4/255,b8=b5/255,b9=b8*b7,ca=b9*(1-Math.abs(b6/60%2-1)),cb=b8-b9,cc,cd,ce;if(b6>=0&&b6<60){cc=b9;cd=ca;ce=0}else if(b6>=60&&b6<120){cc=ca;cd=b9;ce=0}else if(b6>=120&&b6<180){cc=0;cd=b9;ce=ca}else if(b6>=180&&b6<240){cc=0;cd=ca;ce=b9}else if(b6>=240&&b6<300){cc=ca;cd=0;ce=b9}else{cc=b9;cd=0;ce=ca}const cf=cf=>Math.round((cf+cb)*255).toString(16).padStart(2,'0');return'#'+cf(cc)+cf(cd)+cf(ce)}function aY(){let cg;if(e){const bQ=f*255/360;cg=bw(bQ,g,h)}else{const ch=b[c].effects[d];cg=ch.head}[v,w,x,y].forEach(ci=>{const cj=ci.querySelectorAll('.flower-petal');cj.forEach(ck=>{ck.style.fill=cg});ci.querySelector('.flower-svg').style.filter=`drop-shadow(0 0 15px ${cg})`;ci.style.setProperty('--flower-color',cg)});z.style.background=cg;A.style.background=cg}function aZ(){if(e){B.textContent='CUSTOM';C.textContent='';D.textContent='Custom Color';D.classList.add('custom')}else{const cl=b[c],cm=cl.effects[d];B.textContent=`P${cl.id}`;C.textContent=`${d+1}/${cl.effects.length}`;D.textContent=cm.name;D.classList.remove('custom')}}function cn(co,cp,cq){const cr=window.devicePixelRatio||1,cs=cp.parentElement.getBoundingClientRect(),ct=Math.max(1,cs.width),cu=Math.max(1,cs.height);cp.width=ct*cr;cp.height=cu*cr;co.scale(cr,cr);co.fillStyle='#1a1e28';co.fillRect(0,0,ct,cu);const cv=ct/2,cw=co.createLinearGradient(0,0,cv,0),cx=co.createLinearGradient(cv,0,ct,0);cw.addColorStop(0,cq);cw.addColorStop(1,'#fff');cx.addColorStop(0,'#fff');cx.addColorStop(1,cq);co.fillStyle=cw;co.fillRect(0,0,cv,cu);co.fillStyle=cx;co.fillRect(cv,0,cv,cu);const cy=co.createLinearGradient(0,0,ct,0),cz=(Math.sin(Date.now()*.002)+1)/2;cy.addColorStop(Math.max(0,cz-.1),'rgba(255,255,255,0)');cy.addColorStop(cz,'rgba(255,255,255,0.1)');cy.addColorStop(Math.min(1,cz+.1),'rgba(255,255,255,0)');co.fillStyle=cy;co.fillRect(0,0,ct,cu)}function cA(){let cq;if(e){const bQ=f*255/360;cq=bw(bQ,g,h);cn(H,G,cq);cn(F,E,cq)}else{cq=b[c].effects[d].head;cn(F,E,cq)}requestAnimationFrame(cA)}async function cB(){try{const cC=await fetch('/api/status'),cD=await cC.json();c=cD.currentPage;d=cD.currentEffect;e=cD.customColorMode;f=ba(cD.headHue);g=cD.headSat||200;h=cD.headVal||220;aM();aR();aY();aZ();if(e){u.classList.add('active');t.classList.remove('active');p.style.display='none';s.classList.add('visible');k.classList.add('custom-mode');l.classList.add('custom-mode');m.classList.add('custom-mode');m.textContent='Custom Mode';n.textContent='Custom';n.classList.add('custom')}else{t.classList.add('active');u.classList.remove('active');p.style.display='block';s.classList.remove('visible');k.classList.remove('custom-mode');l.classList.remove('custom-mode');m.classList.remove('custom-mode');m.textContent='Effects Mode';n.textContent='Effect';n.classList.remove('custom')}J.style.left=f/360*100+'%';J.style.background=bn(f,100,50);L.style.left=g/255*100+'%';N.style.left=h/255*100+'%';O.textContent=cD.headHue;P.textContent=g;Q.textContent=h;bo()}catch(cE){}}function init(){aM();aR();aY();aZ();bg();bD();cA();setInterval(cB,3000)}init();");
  html += F("</script></body></html>");
  return html;
}