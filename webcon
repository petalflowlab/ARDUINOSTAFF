<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LED Staff Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a0c10;
            --bg-card: #12151c;
            --bg-elevated: #1a1e28;
            --border: rgba(255, 255, 255, 0.06);
            --text-primary: #f0f2f5;
            --text-secondary: #7a8494;
            --text-muted: #4a5260;
            --accent: #00d4aa;
            --accent-glow: rgba(0, 212, 170, 0.4);
            --accent-dim: #00a080;
            --danger: #ff4757;
            --custom-mode: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-deep);
            min-height: 100vh;
            min-height: 100dvh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .bg-glow {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
        }

        .bg-glow::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at 30% 20%, var(--accent-glow) 0%, transparent 50%),
                        radial-gradient(ellipse at 70% 80%, rgba(80, 60, 200, 0.15) 0%, transparent 50%);
            animation: bgShift 20s ease-in-out infinite;
        }

        .bg-glow.custom-mode::before {
            background: radial-gradient(ellipse at 30% 20%, rgba(245, 158, 11, 0.3) 0%, transparent 50%),
                        radial-gradient(ellipse at 70% 80%, rgba(251, 191, 36, 0.15) 0%, transparent 50%);
        }

        @keyframes bgShift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(2%, 1%) rotate(1deg); }
            66% { transform: translate(-1%, 2%) rotate(-1deg); }
        }

        .app {
            position: relative;
            z-index: 1;
            max-width: 420px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
            min-height: 100dvh;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            margin-bottom: 0.75rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dim));
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .logo-icon.custom-mode {
            background: linear-gradient(135deg, var(--custom-mode), #d97706);
        }

        .logo-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--bg-deep);
            stroke-width: 2.5;
            fill: none;
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: -0.5px;
        }

        .mode-badge {
            font-size: 0.55rem;
            font-weight: 700;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-elevated);
            color: var(--text-muted);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .mode-badge.custom-mode {
            background: var(--custom-mode);
            color: var(--bg-deep);
            border-color: transparent;
        }

        /* Staff Visualization */
        .staff-visual {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .staff-label {
            font-size: 0.6rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .staff-mode-indicator {
            font-size: 0.55rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .staff-mode-indicator.custom {
            background: var(--custom-mode);
            color: var(--bg-deep);
        }

        .staff-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            padding: 0.5rem 0;
            min-height: 100px;
        }

        /* Flower Petal Shape - Sharp Triangular */
        .flower-end {
            width: 70px;
            height: 70px;
            position: relative;
            flex-shrink: 0;
        }

        .flower-svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 15px var(--flower-color, var(--accent)));
            transition: filter 0.3s;
        }

        .flower-petal {
            fill: var(--flower-color, var(--accent));
            transition: fill 0.3s;
            stroke: rgba(255,255,255,0.2);
            stroke-width: 0.5;
        }

        .flower-center {
            fill: rgba(0, 0, 0, 0.4);
        }

        .staff-middle {
            flex: 1;
            height: 36px;
            background: var(--bg-elevated);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            margin: 0 -2px;
            min-width: 80px; /* Ensure it has some width */
        }

        .staff-pattern {
            position: absolute;
            inset: 0;
        }

        .staff-pattern canvas {
            width: 100%;
            height: 100%;
        }

        .staff-info {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.6rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .staff-info-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: var(--text-muted);
        }

        .staff-info-item span:first-child {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .mode-btn {
            flex: 1;
            padding: 0.6rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            font-family: 'Space Grotesk', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }

        .mode-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .mode-btn:hover {
            background: var(--bg-elevated);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .mode-btn.active {
            border-color: transparent;
        }

        .mode-btn.effects.active {
            background: var(--accent);
            color: var(--bg-deep);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .mode-btn.custom.active {
            background: var(--custom-mode);
            color: var(--bg-deep);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        /* Effects Section */
        .effects-section {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 0.85rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }

        .effects-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .effects-title {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Page Navigation */
        .page-nav {
            display: flex;
            gap: 0.25rem;
        }

        .page-tab {
            padding: 0.3rem 0.55rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.6rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .page-tab:hover {
            background: var(--bg-deep);
            color: var(--text-primary);
        }

        .page-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-deep);
        }

        .effects-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem;
            color: var(--text-secondary);
            background: var(--bg-elevated);
            padding: 0.2rem 0.45rem;
            border-radius: 6px;
        }

        .effects-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.4rem;
        }

        .effect-btn {
            position: relative;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.55rem 0.35rem;
            font-size: 0.65rem;
            font-weight: 600;
            font-family: 'Space Grotesk', sans-serif;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }

        .effect-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--effect-head, var(--accent));
        }

        .effect-btn::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--effect-tail, var(--accent-dim));
        }

        .effect-btn:hover {
            background: var(--bg-deep);
            border-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .effect-btn.active {
            background: linear-gradient(135deg, var(--effect-head, var(--accent)), var(--effect-tail, var(--accent-dim)));
            border-color: transparent;
            color: var(--bg-deep);
            box-shadow: 0 3px 12px var(--accent-glow);
        }

        .effect-btn.active::before,
        .effect-btn.active::after {
            width: 0;
        }

        /* Custom Color Section */
        .custom-section {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 0.85rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            display: none;
        }

        .custom-section.visible {
            display: block;
        }

        .custom-title {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        /* Custom Staff Preview (Matches Main Preview) */
        .custom-staff-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }

        .custom-flower {
            width: 50px;
            height: 50px;
            flex-shrink: 0;
        }

        .custom-middle {
            flex: 1;
            height: 24px;
            background: var(--bg-elevated);
            border-radius: 4px;
            margin: 0 -2px;
            position: relative;
            overflow: hidden;
        }

        #customPreviewCanvas {
            width: 100%;
            height: 100%;
        }

        /* Head/Tail Color Picker */
        .head-tail-picker {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-elevated);
            border-radius: 10px;
            margin-bottom: 0.75rem;
        }

        .color-picker-area {
            flex: 1;
        }

        .picker-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-bottom: 0.3rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hue-slider-container {
            position: relative;
            height: 24px;
            border-radius: 12px;
            background: linear-gradient(to right, 
                hsl(0, 100%, 50%),
                hsl(60, 100%, 50%),
                hsl(120, 100%, 50%),
                hsl(180, 100%, 50%),
                hsl(240, 100%, 50%),
                hsl(300, 100%, 50%),
                hsl(360, 100%, 50%)
            );
            cursor: pointer;
        }

        .hue-thumb {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--custom-color, var(--custom-mode));
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }

        /* Center Bar Hue Editor */
        .center-bar-editor {
            margin-top: 0.75rem;
        }

        .center-bar-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .add-color-btn {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.35rem 0.6rem;
            background: var(--custom-mode);
            border: none;
            border-radius: 6px;
            font-size: 0.6rem;
            font-weight: 600;
            color: var(--bg-deep);
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-color-btn:hover {
            filter: brightness(1.1);
        }

        .add-color-btn svg {
            width: 12px;
            height: 12px;
            stroke: currentColor;
            stroke-width: 2.5;
        }

        .multi-hue-bar {
            position: relative;
            height: 36px;
            border-radius: 8px;
            background: var(--bg-elevated);
            overflow: visible;
            margin-bottom: 0.5rem;
        }

        .gradient-preview {
            position: absolute;
            inset: 0;
            border-radius: 8px;
            pointer-events: none;
        }

        .color-marker {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 36px;
            border-radius: 4px;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            cursor: grab;
            transition: transform 0.1s, box-shadow 0.1s;
            z-index: 1;
        }

        .color-marker:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .color-marker.selected {
            border-color: var(--custom-mode);
            box-shadow: 0 0 0 2px var(--custom-mode), 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        .color-marker.dragging {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.15);
        }

        .remove-marker-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--danger);
            border: 2px solid var(--bg-card);
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 3;
        }

        .color-marker.selected .remove-marker-btn {
            display: flex;
        }

        .remove-marker-btn svg {
            width: 8px;
            height: 8px;
            stroke: white;
            stroke-width: 3;
        }

        /* Selected Marker Hue Picker */
        .marker-hue-picker {
            background: var(--bg-elevated);
            border-radius: 8px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            display: none;
        }

        .marker-hue-picker.visible {
            display: block;
        }

        .hue-picker-label {
            font-size: 0.55rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }

        .hue-picker-slider {
            position: relative;
            height: 20px;
            border-radius: 10px;
            background: linear-gradient(to right, 
                hsl(0, 100%, 50%),
                hsl(60, 100%, 50%),
                hsl(120, 100%, 50%),
                hsl(180, 100%, 50%),
                hsl(240, 100%, 50%),
                hsl(300, 100%, 50%),
                hsl(360, 100%, 50%)
            );
            cursor: pointer;
        }

        .hue-picker-thumb {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }

        /* Controls */
        .controls-section {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 0.85rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }

        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .control-row:last-child {
            border-bottom: none;
        }

        .control-label {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .control-desc {
            font-size: 0.55rem;
            color: var(--text-muted);
            margin-top: 0.1rem;
        }

        .toggle-switch {
            display: flex;
            background: var(--bg-elevated);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .toggle-option {
            padding: 0.35rem 0.7rem;
            font-size: 0.65rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
        }

        .toggle-option.active {
            background: var(--accent);
            color: var(--bg-deep);
        }

        .main-toggle {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.4rem;
        }

        .main-toggle-btn {
            flex: 1;
            padding: 0.6rem;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 600;
            font-family: 'Space Grotesk', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .main-toggle-btn:hover {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .main-toggle-btn.on.active {
            background: var(--accent);
            color: var(--bg-deep);
            border-color: transparent;
            box-shadow: 0 3px 15px var(--accent-glow);
        }

        .main-toggle-btn.blackout.active {
            background: var(--danger);
            color: white;
            border-color: transparent;
            box-shadow: 0 3px 15px rgba(255, 71, 87, 0.4);
        }

        /* Firmware Button */
        .firmware-btn {
            width: 100%;
            padding: 0.7rem;
            background: linear-gradient(135deg, var(--bg-elevated), var(--bg-card));
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.7rem;
            font-weight: 600;
            font-family: 'Space Grotesk', sans-serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
            margin-bottom: 0.75rem;
        }

        .firmware-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--accent);
        }

        .firmware-btn svg {
            width: 14px;
            height: 14px;
            stroke: var(--accent);
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.7rem;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 0.6rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: var(--text-muted);
        }

        .status-page {
            background: var(--bg-elevated);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            color: var(--text-secondary);
        }

        .status-effect {
            color: var(--accent);
            font-weight: 500;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .status-effect.custom {
            color: var(--custom-mode);
        }

        /* Instructions */
        .instructions {
            text-align: center;
            margin-top: 0.6rem;
            font-size: 0.55rem;
            color: var(--text-muted);
            letter-spacing: 0.3px;
        }

        .file-input {
            display: none;
        }

        /* Responsive */
        @media (max-width: 360px) {
            .effects-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .flower-end {
                width: 60px;
                height: 60px;
            }

            .custom-flower {
                width: 40px;
                height: 40px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="bg-glow" id="bgGlow"></div>
    
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon" id="logoIcon">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2L12 22M12 2L8 6M12 2L16 6M12 22L8 18M12 22L16 18"/>
                    </svg>
                </div>
                <span class="logo-text">LED Staff</span>
            </div>
            <div>
                <span class="mode-badge" id="modeBadge">Effects Mode</span>
            </div>
        </header>

        <!-- Staff Visualization -->
        <div class="staff-visual">
            <div class="staff-label">
                <span>Live Preview</span>
                <span class="staff-mode-indicator" id="staffModeIndicator">Effect</span>
            </div>
            <div class="staff-container">
                <!-- Head Flower -->
                <div class="flower-end" id="flowerHead">
                    <!-- SVG injected by JS to keep HTML clean -->
                </div>
                
                <!-- Middle Staff -->
                <div class="staff-middle">
                    <div class="staff-pattern">
                        <canvas id="patternCanvas"></canvas>
                    </div>
                </div>
                
                <!-- Tail Flower -->
                <div class="flower-end" id="flowerTail">
                    <!-- SVG injected by JS -->
                </div>
            </div>
            <div class="staff-info">
                <div class="staff-info-item">
                    <span id="headSwatch"></span>
                    Head
                </div>
                <div class="staff-info-item">Center Pattern</div>
                <div class="staff-info-item">
                    Tail
                    <span id="tailSwatch"></span>
                </div>
            </div>
        </div>

        <!-- Mode Toggle -->
        <div class="mode-toggle">
            <button class="mode-btn effects active" id="effectsModeBtn">
                <svg viewBox="0 0 24 24">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
                Effects
            </button>
            <button class="mode-btn custom" id="customModeBtn">
                <svg viewBox="0 0 24 24">
                    <circle cx="13.5" cy="6.5" r="2.5"/>
                    <circle cx="17.5" cy="10.5" r="2.5"/>
                    <circle cx="8.5" cy="7.5" r="2.5"/>
                    <circle cx="6.5" cy="12.5" r="2.5"/>
                    <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.93 0 1.82-.13 2.67-.35"/>
                </svg>
                Custom Color
            </button>
        </div>

        <!-- Effects Section -->
        <section class="effects-section" id="effectsSection">
            <div class="effects-header">
                <span class="effects-title">Effects</span>
                <div class="page-nav" id="pageNav"></div>
                <span class="effects-count" id="effectsCount">1 of 6</span>
            </div>
            <div class="effects-grid" id="effectsGrid"></div>
        </section>

        <!-- Custom Color Section -->
        <section class="custom-section" id="customSection">
            <div class="custom-title">Head & Tail Color (Mirrored)</div>
            
            <!-- Custom Preview mirroring main layout -->
            <div class="custom-staff-preview">
                <div class="custom-flower" id="customFlowerHead"></div>
                <div class="custom-middle">
                    <canvas id="customPreviewCanvas"></canvas>
                </div>
                <div class="custom-flower" id="customFlowerTail"></div>
            </div>

            <div class="head-tail-picker">
                <div class="color-picker-area" style="width: 100%;">
                    <div class="picker-label">Head & Tail Hue</div>
                    <div class="hue-slider-container" id="headTailHueBar">
                        <div class="hue-thumb" id="headTailHueThumb"></div>
                    </div>
                </div>
            </div>

            <div class="center-bar-editor">
                <div class="center-bar-label">
                    <span class="custom-title" style="margin-bottom: 0;">Center Bar Colors</span>
                    <button class="add-color-btn" id="addColorBtn">
                        <svg viewBox="0 0 24 24">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add
                    </button>
                </div>
                <div class="multi-hue-bar" id="multiHueBar">
                    <div class="gradient-preview" id="gradientPreview"></div>
                </div>
                
                <!-- Selected Marker Hue Picker -->
                <div class="marker-hue-picker" id="markerHuePicker">
                    <div class="hue-picker-label">Selected Color Hue</div>
                    <div class="hue-picker-slider" id="markerHueSlider">
                        <div class="hue-picker-thumb" id="markerHueThumb"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Controls -->
        <section class="controls-section">
            <div class="control-row">
                <div>
                    <div class="control-label">Brightness</div>
                    <div class="control-desc">70% = real 50% / 100% = real 70%</div>
                </div>
                <div class="toggle-switch" id="brightnessToggle">
                    <button class="toggle-option active" data-value="70">70%</button>
                    <button class="toggle-option" data-value="100">100%</button>
                </div>
            </div>
            
            <div class="main-toggle">
                <button class="main-toggle-btn on active" id="effectOn">Effect On</button>
                <button class="main-toggle-btn blackout" id="blackout">Blackout</button>
            </div>
        </section>

        <!-- Firmware Button -->
        <label class="firmware-btn" for="firmwareFile">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Update Firmware
        </label>
        <input type="file" id="firmwareFile" class="file-input" accept=".bin">

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <span class="status-page" id="statusPage">P1</span>
                <span id="statusIndex">1/6</span>
            </div>
            <span class="status-effect" id="statusEffect">Purple Blob</span>
            <span style="color: var(--text-muted);">192.168.4.1</span>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            Click marker to select, then use hue slider below. Drag to position.
        </div>
    </div>

    <script>
        // Sharp Flower SVG Template
        const flowerSVG = `
            <svg class="flower-svg" viewBox="0 0 100 100">
                <g class="petals-group">
                    <path class="flower-petal" d="M50,50 L40,15 L50,0 L60,15 Z" transform="rotate(0 50 50)"/>
                    <path class="flower-petal" d="M50,50 L40,15 L50,0 L60,15 Z" transform="rotate(72 50 50)"/>
                    <path class="flower-petal" d="M50,50 L40,15 L50,0 L60,15 Z" transform="rotate(144 50 50)"/>
                    <path class="flower-petal" d="M50,50 L40,15 L50,0 L60,15 Z" transform="rotate(216 50 50)"/>
                    <path class="flower-petal" d="M50,50 L40,15 L50,0 L60,15 Z" transform="rotate(288 50 50)"/>
                </g>
                <circle class="flower-center" cx="50" cy="50" r="8"/>
            </svg>
        `;

        // Effect data
        const pages = [
            {
                id: 1,
                name: 'Purple & Elemental',
                effects: [
                    { name: 'Purple Blob', head: '#9b59b6', middle: ['#9b59b6', '#8e44ad', '#6c3483'] },
                    { name: 'Rainbow Painter', head: '#ff6b6b', middle: ['#ff6b6b', '#feca57', '#4ecdc4'] },
                    { name: 'Fire Storm', head: '#ff8c42', middle: ['#ff8c42', '#ff6b35', '#e63946'] },
                    { name: 'Ocean Waves', head: '#4aa3ff', middle: ['#4aa3ff', '#48cae4', '#2c7da0'] },
                    { name: 'Crystal Pulse', head: '#ff6b9d', middle: ['#ff6b9d', '#c77dff', '#bf4aa8'] },
                    { name: 'Ping Pong', head: '#f9d56e', middle: ['#f9d56e', '#ffb347', '#e08e45'] }
                ]
            },
            {
                id: 2,
                name: 'Audio Reactive',
                effects: [
                    { name: 'Audio Pulse', head: '#845ec2', middle: ['#845ec2', '#a178df', '#6c5b7b'] },
                    { name: 'Beat Sparkle', head: '#ffc75f', middle: ['#ffc75f', '#ffe066', '#f9f3b0'] },
                    { name: 'Sound Wave', head: '#2c73d2', middle: ['#2c73d2', '#48cae4', '#5f9ea0'] },
                    { name: 'Color Shift', head: '#b39cd0', middle: ['#b39cd0', '#c77dff', '#9b89b3'] },
                    { name: 'Audio Fire', head: '#ff5e78', middle: ['#ff5e78', '#ff758f', '#d64161'] }
                ]
            },
            {
                id: 3,
                name: 'Cosmic',
                effects: [
                    { name: 'Plasma Storm', head: '#a178df', middle: ['#a178df', '#c77dff', '#845ec2'] },
                    { name: 'Lightning Strike', head: '#f9f3b0', middle: ['#f9f3b0', '#fff3b0', '#ffd966'] },
                    { name: 'Comet Trail', head: '#ff9671', middle: ['#ff9671', '#ff7b54', '#e15554'] },
                    { name: 'Aurora Flow', head: '#6cd4c5', middle: ['#6cd4c5', '#48cae4', '#4c9a8a'] },
                    { name: 'Galaxy Swirl', head: '#8b6eb0', middle: ['#8b6eb0', '#c77dff', '#6c4f7e'] }
                ]
            },
            {
                id: 4,
                name: 'Calming',
                effects: [
                    { name: 'Ocean Breeze', head: '#4c9a8a', middle: ['#4c9a8a', '#48cae4', '#2c7da0'] },
                    { name: 'Sunset Fade', head: '#ff9671', middle: ['#ff9671', '#ff9f1c', '#e15554'] },
                    { name: 'Forest Mist', head: '#6d9773', middle: ['#6d9773', '#95d5b2', '#527a5a'] },
                    { name: 'Aurora Dreams', head: '#a186be', middle: ['#a186be', '#c77dff', '#8b6eb0'] },
                    { name: 'Lava Flow', head: '#e15554', middle: ['#e15554', '#ff6b35', '#b83b3a'] }
                ]
            },
            {
                id: 5,
                name: 'Fruity',
                effects: [
                    { name: 'Watermelon', head: '#fc4a4a', middle: ['#fc4a4a', '#ff6b6b', '#2e8b57'] },
                    { name: 'Citrus Burst', head: '#ffaa33', middle: ['#ffaa33', '#ffb347', '#ffd700'] },
                    { name: 'Berry Blast', head: '#a55c9e', middle: ['#a55c9e', '#c77dff', '#8a4f84'] },
                    { name: 'Mango Swirl', head: '#ffb347', middle: ['#ffb347', '#ff9f1c', '#ff8c42'] },
                    { name: 'Kiwi Spark', head: '#7fb07f', middle: ['#7fb07f', '#95d5b2', '#8b5a2b'] }
                ]
            }
        ];

        // State
        let currentPage = 0;
        let currentEffect = 0;
        let isCustomMode = false;
        let customHeadTailHue = 30;
        let centerBarColors = [
            { position: 0, hue: 0 },
            { position: 50, hue: 180 },
            { position: 100, hue: 280 }
        ];
        let selectedMarkerIndex = 0;
        let brightness = 70;
        let effectOn = true;

        // DOM Elements
        const bgGlow = document.getElementById('bgGlow');
        const logoIcon = document.getElementById('logoIcon');
        const modeBadge = document.getElementById('modeBadge');
        const staffModeIndicator = document.getElementById('staffModeIndicator');
        const pageNav = document.getElementById('pageNav');
        const effectsSection = document.getElementById('effectsSection');
        const effectsGrid = document.getElementById('effectsGrid');
        const effectsCount = document.getElementById('effectsCount');
        const customSection = document.getElementById('customSection');
        const effectsModeBtn = document.getElementById('effectsModeBtn');
        const customModeBtn = document.getElementById('customModeBtn');
        
        // Inject Flower HTML
        const flowerHead = document.getElementById('flowerHead');
        const flowerTail = document.getElementById('flowerTail');
        const customFlowerHead = document.getElementById('customFlowerHead');
        const customFlowerTail = document.getElementById('customFlowerTail');
        
        flowerHead.innerHTML = flowerSVG;
        flowerTail.innerHTML = flowerSVG;
        customFlowerHead.innerHTML = flowerSVG;
        customFlowerTail.innerHTML = flowerSVG;

        const headSwatch = document.getElementById('headSwatch');
        const tailSwatch = document.getElementById('tailSwatch');
        const statusPage = document.getElementById('statusPage');
        const statusIndex = document.getElementById('statusIndex');
        const statusEffect = document.getElementById('statusEffect');
        const patternCanvas = document.getElementById('patternCanvas');
        const ctx = patternCanvas.getContext('2d');
        
        const customPreviewCanvas = document.getElementById('customPreviewCanvas');
        const customCtx = customPreviewCanvas.getContext('2d');

        const headTailHueBar = document.getElementById('headTailHueBar');
        const headTailHueThumb = document.getElementById('headTailHueThumb');
        const multiHueBar = document.getElementById('multiHueBar');
        const gradientPreview = document.getElementById('gradientPreview');
        const addColorBtn = document.getElementById('addColorBtn');
        const markerHuePicker = document.getElementById('markerHuePicker');
        const markerHueSlider = document.getElementById('markerHueSlider');
        const markerHueThumb = document.getElementById('markerHueThumb');

        // Initialize page navigation
        function initPageNav() {
            pageNav.innerHTML = '';
            pages.forEach((page, index) => {
                const tab = document.createElement('button');
                tab.className = `page-tab ${index === currentPage ? 'active' : ''}`;
                tab.textContent = `P${page.id}`;
                tab.onclick = () => switchPage(index);
                pageNav.appendChild(tab);
            });
        }

        // Initialize effects grid
        function initEffectsGrid() {
            effectsGrid.innerHTML = '';
            const page = pages[currentPage];
            
            page.effects.forEach((effect, index) => {
                const btn = document.createElement('button');
                btn.className = `effect-btn ${index === currentEffect ? 'active' : ''}`;
                btn.textContent = effect.name;
                btn.style.setProperty('--effect-head', effect.head);
                btn.style.setProperty('--effect-tail', effect.head); // Same color
                btn.onclick = () => selectEffect(index);
                effectsGrid.appendChild(btn);
            });

            effectsCount.textContent = `${currentEffect + 1} of ${page.effects.length}`;
        }

        // Switch page
        function switchPage(pageIndex) {
            currentPage = pageIndex;
            currentEffect = 0;
            
            document.querySelectorAll('.page-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === pageIndex);
            });
            
            initEffectsGrid();
            updateStaffVisual();
            updateStatus();
        }

        // Select effect
        function selectEffect(effectIndex) {
            currentEffect = effectIndex;
            
            document.querySelectorAll('.effect-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === effectIndex);
            });
            
            const page = pages[currentPage];
            effectsCount.textContent = `${effectIndex + 1} of ${page.effects.length}`;
            
            updateStaffVisual();
            updateStatus();
        }

        // Update staff visual
        function updateStaffVisual() {
            let color;
            if (isCustomMode) {
                color = hslToHex(customHeadTailHue, 100, 50);
            } else {
                const effect = pages[currentPage].effects[currentEffect];
                color = effect.head; // Head and Tail are same
            }
            
            // Set all flowers (Main Head/Tail, Custom Preview Head/Tail)
            [flowerHead, flowerTail, customFlowerHead, customFlowerTail].forEach(el => {
                setFlowerColor(el, color);
            });
            
            headSwatch.style.background = color;
            tailSwatch.style.background = color;
        }

        // Set flower color
        function setFlowerColor(flowerEl, color) {
            const petals = flowerEl.querySelectorAll('.flower-petal');
            petals.forEach(petal => {
                petal.style.fill = color;
            });
            flowerEl.querySelector('.flower-svg').style.filter = `drop-shadow(0 0 15px ${color})`;
            flowerEl.style.setProperty('--flower-color', color);
        }

        // HSL to Hex conversion
        function hslToHex(h, s, l) {
            s /= 100;
            l /= 100;
            const a = s * Math.min(l, 1 - l);
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }

        // Update status
        function updateStatus() {
            if (isCustomMode) {
                statusPage.textContent = 'CUSTOM';
                statusIndex.textContent = '';
                statusEffect.textContent = 'Custom Color';
                statusEffect.classList.add('custom');
            } else {
                const page = pages[currentPage];
                const effect = page.effects[currentEffect];
                statusPage.textContent = `P${page.id}`;
                statusIndex.textContent = `${currentEffect + 1}/${page.effects.length}`;
                statusEffect.textContent = effect.name;
                statusEffect.classList.remove('custom');
            }
        }

        // Draw Symmetric Pattern
        function drawSymmetricPattern(targetCtx, targetCanvas, colors) {
            const dpr = window.devicePixelRatio || 1;
            const rect = targetCanvas.parentElement.getBoundingClientRect();
            const width = Math.max(1, rect.width);
            const height = Math.max(1, rect.height);
            
            targetCanvas.width = width * dpr;
            targetCanvas.height = height * dpr;
            targetCtx.scale(dpr, dpr);
            
            targetCtx.fillStyle = '#1a1e28';
            targetCtx.fillRect(0, 0, width, height);
            
            const centerX = width / 2;
            
            // Create symmetric gradient
            // Left half: Colors from center out (reverse of array)
            // Right half: Colors from center out (normal array)
            
            // For effects, colors are [Outer, Middle, Inner] relative to center?
            // Or [CenterColor, MidColor, EdgeColor]?
            // Let's assume array is from Center -> Edge.
            // So Left side: Center is at width/2. Edge is at 0.
            // Right side: Center is at width/2. Edge is at width.
            
            // If colors are [C1, C2, C3], C1 is at center, C3 is at tips.
            
            const gradientLeft = targetCtx.createLinearGradient(0, 0, centerX, 0);
            const gradientRight = targetCtx.createLinearGradient(centerX, 0, width, 0);
            
            // Map colors to stops
            // Left: 0% is Tip (C_last), 100% is Center (C_first)
            // Right: 0% is Center (C_first), 100% is Tip (C_last)
            
            const numColors = colors.length;
            colors.forEach((c, i) => {
                const stop = i / (numColors - 1);
                // Right side: 0 to 1 maps to Center to Tip
                gradientRight.addColorStop(stop, c);
                // Left side: 0 to 1 maps to Tip to Center (inverted stop)
                gradientLeft.addColorStop(1 - stop, c);
            });
            
            targetCtx.fillStyle = gradientLeft;
            targetCtx.fillRect(0, 0, centerX, height);
            
            targetCtx.fillStyle = gradientRight;
            targetCtx.fillRect(centerX, 0, centerX, height);
            
            // Shimmer
            const shimmerGrad = targetCtx.createLinearGradient(0, 0, width, 0);
            const shimmerPos = (Math.sin(Date.now() * 0.002) + 1) / 2;
            shimmerGrad.addColorStop(Math.max(0, shimmerPos - 0.1), 'rgba(255,255,255,0)');
            shimmerGrad.addColorStop(shimmerPos, 'rgba(255,255,255,0.1)');
            shimmerGrad.addColorStop(Math.min(1, shimmerPos + 0.1), 'rgba(255,255,255,0)');
            targetCtx.fillStyle = shimmerGrad;
            targetCtx.fillRect(0, 0, width, height);
        }

        // Animation Loop
        let animationFrame;
        function animate() {
            if (isCustomMode) {
                // Draw Custom Preview Canvas
                const sortedColors = [...centerBarColors].sort((a, b) => a.position - b.position);
                // We need to mirror the gradient logic for custom bar too
                // But custom bar is defined by positions.
                // Let's make custom bar symmetric too: markers define one half?
                // Or just use the markers as defined but draw them on both sides?
                // User said "Center bar colours... symmetrical colours down the middle"
                // So if marker is at 20%, there should be a color at 80%?
                // For simplicity, let's just use the defined gradient for the custom preview 
                // but draw it symmetrically if that's the intent.
                // Actually, custom bar should just reflect the markers.
                // If user wants symmetry, they place markers symmetrically.
                // Let's just draw the standard gradient for custom preview.
                
                const gradient = customCtx.createLinearGradient(0, 0, customPreviewCanvas.width, 0);
                const dpr = window.devicePixelRatio || 1;
                const rect = customPreviewCanvas.parentElement.getBoundingClientRect();
                customPreviewCanvas.width = rect.width * dpr;
                customPreviewCanvas.height = rect.height * dpr;
                customCtx.scale(dpr, dpr);
                
                const sorted = [...centerBarColors].sort((a, b) => a.position - b.position);
                const stops = sorted.map(c => ({
                    offset: c.position / 100,
                    color: hslToHex(c.hue, 100, 50)
                }));
                
                stops.forEach(s => gradient.addColorStop(s.offset, s.color));
                customCtx.fillStyle = gradient;
                customCtx.fillRect(0, 0, rect.width, rect.height);
                
            } else {
                const effect = pages[currentPage].effects[currentEffect];
                drawSymmetricPattern(ctx, patternCanvas, effect.middle);
            }
            
            animationFrame = requestAnimationFrame(animate);
        }

        // Mode toggle
        effectsModeBtn.addEventListener('click', () => {
            isCustomMode = false;
            effectsModeBtn.classList.add('active');
            customModeBtn.classList.remove('active');
            
            effectsSection.style.display = 'block';
            customSection.classList.remove('visible');
            
            bgGlow.classList.remove('custom-mode');
            logoIcon.classList.remove('custom-mode');
            modeBadge.classList.remove('custom-mode');
            modeBadge.textContent = 'Effects Mode';
            staffModeIndicator.textContent = 'Effect';
            staffModeIndicator.classList.remove('custom');
            
            updateStaffVisual();
            updateStatus();
        });

        customModeBtn.addEventListener('click', () => {
            isCustomMode = true;
            customModeBtn.classList.add('active');
            effectsModeBtn.classList.remove('active');
            
            effectsSection.style.display = 'none';
            customSection.classList.add('visible');
            
            bgGlow.classList.add('custom-mode');
            logoIcon.classList.add('custom-mode');
            modeBadge.classList.add('custom-mode');
            modeBadge.textContent = 'Custom Mode';
            staffModeIndicator.textContent = 'Custom';
            staffModeIndicator.classList.add('custom');
            
            updateStaffVisual();
            updateStatus();
            updateGradientPreview();
            updateMarkerHuePicker();
        });

        // Head/Tail Hue Slider
        function initHeadTailHueSlider() {
            let isDragging = false;
            
            const updateThumb = (clientX) => {
                const rect = headTailHueBar.getBoundingClientRect();
                let x = clientX - rect.left;
                x = Math.max(0, Math.min(x, rect.width));
                customHeadTailHue = (x / rect.width) * 360;
                
                headTailHueThumb.style.left = `${(customHeadTailHue / 360) * 100}%`;
                const color = hslToHex(customHeadTailHue, 100, 50);
                headTailHueThumb.style.background = color;
                
                // Update all flowers
                updateStaffVisual();
            };
            
            headTailHueBar.addEventListener('mousedown', (e) => {
                isDragging = true;
                updateThumb(e.clientX);
            });
            
            headTailHueBar.addEventListener('touchstart', (e) => {
                isDragging = true;
                updateThumb(e.touches[0].clientX);
            }, { passive: true });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging) updateThumb(e.clientX);
            });
            
            document.addEventListener('touchmove', (e) => {
                if (isDragging) updateThumb(e.touches[0].clientX);
            }, { passive: true });
            
            document.addEventListener('mouseup', () => isDragging = false);
            document.addEventListener('touchend', () => isDragging = false);
            
            // Initialize thumb position
            headTailHueThumb.style.left = `${(customHeadTailHue / 360) * 100}%`;
            headTailHueThumb.style.background = hslToHex(customHeadTailHue, 100, 50);
        }

        // Multi-color bar with markers
        function updateGradientPreview() {
            const sortedColors = [...centerBarColors].sort((a, b) => a.position - b.position);
            const stops = sortedColors.map(c => {
                const hex = hslToHex(c.hue, 100, 50);
                return `${hex} ${c.position}%`;
            }).join(', ');
            
            gradientPreview.style.background = `linear-gradient(to right, ${stops})`;
        }

        function updateMarkerHuePicker() {
            if (selectedMarkerIndex >= 0 && selectedMarkerIndex < centerBarColors.length) {
                const hue = centerBarColors[selectedMarkerIndex].hue;
                markerHueThumb.style.left = `${(hue / 360) * 100}%`;
                markerHueThumb.style.background = hslToHex(hue, 100, 50);
                markerHuePicker.classList.add('visible');
            }
        }

        function createMarker(color, index) {
            const marker = document.createElement('div');
            marker.className = 'color-marker';
            if (index === selectedMarkerIndex) marker.classList.add('selected');
            marker.style.left = `${color.position}%`;
            marker.style.background = hslToHex(color.hue, 100, 50);
            marker.dataset.index = index;
            
            const removeBtn = document.createElement('div');
            removeBtn.className = 'remove-marker-btn';
            removeBtn.innerHTML = '<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
            
            marker.appendChild(removeBtn);
            multiHueBar.appendChild(marker);
            
            // Click to select
            marker.addEventListener('click', (e) => {
                if (e.target.closest('.remove-marker-btn')) {
                    if (centerBarColors.length > 2) {
                        centerBarColors.splice(index, 1);
                        if (selectedMarkerIndex >= centerBarColors.length) {
                            selectedMarkerIndex = centerBarColors.length - 1;
                        }
                        renderMarkers();
                        updateGradientPreview();
                        updateMarkerHuePicker();
                    }
                    return;
                }
                
                document.querySelectorAll('.color-marker').forEach(m => m.classList.remove('selected'));
                marker.classList.add('selected');
                selectedMarkerIndex = index;
                updateMarkerHuePicker();
            });
            
            // Dragging
            let isDragging = false;
            
            const startDrag = (clientX) => {
                isDragging = true;
                marker.classList.add('dragging');
            };
            
            const doDrag = (clientX) => {
                if (!isDragging) return;
                
                const rect = multiHueBar.getBoundingClientRect();
                let x = clientX - rect.left;
                let newPos = Math.max(0, Math.min(100, (x / rect.width) * 100));
                
                centerBarColors[index].position = newPos;
                marker.style.left = `${newPos}%`;
                updateGradientPreview();
            };
            
            const endDrag = () => {
                isDragging = false;
                marker.classList.remove('dragging');
            };
            
            marker.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startDrag(e.clientX);
            });
            
            marker.addEventListener('touchstart', (e) => {
                startDrag(e.touches[0].clientX);
            }, { passive: true });
            
            document.addEventListener('mousemove', (e) => doDrag(e.clientX));
            document.addEventListener('touchmove', (e) => doDrag(e.touches[0].clientX), { passive: true });
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }

        // Marker hue slider
        function initMarkerHueSlider() {
            let isDragging = false;
            
            const updateHue = (clientX) => {
                const rect = markerHueSlider.getBoundingClientRect();
                let x = clientX - rect.left;
                x = Math.max(0, Math.min(x, rect.width));
                const hue = (x / rect.width) * 360;
                
                centerBarColors[selectedMarkerIndex].hue = hue;
                markerHueThumb.style.left = `${(hue / 360) * 100}%`;
                markerHueThumb.style.background = hslToHex(hue, 100, 50);
                
                // Update marker color
                const marker = document.querySelector(`.color-marker[data-index="${selectedMarkerIndex}"]`);
                if (marker) {
                    marker.style.background = hslToHex(hue, 100, 50);
                }
                
                updateGradientPreview();
            };
            
            markerHueSlider.addEventListener('mousedown', (e) => {
                isDragging = true;
                updateHue(e.clientX);
            });
            
            markerHueSlider.addEventListener('touchstart', (e) => {
                isDragging = true;
                updateHue(e.touches[0].clientX);
            }, { passive: true });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging) updateHue(e.clientX);
            });
            
            document.addEventListener('touchmove', (e) => {
                if (isDragging) updateHue(e.touches[0].clientX);
            }, { passive: true });
            
            document.addEventListener('mouseup', () => isDragging = false);
            document.addEventListener('touchend', () => isDragging = false);
        }

        function renderMarkers() {
            // Remove existing markers
            document.querySelectorAll('.color-marker').forEach(m => m.remove());
            
            // Create new markers
            centerBarColors.forEach((color, index) => {
                createMarker(color, index);
            });
        }

        // Add color button
        addColorBtn.addEventListener('click', () => {
            // Find largest gap
            const sorted = [...centerBarColors].sort((a, b) => a.position - b.position);
            let maxGap = 0;
            let gapPosition = 50;
            
            for (let i = 0; i < sorted.length - 1; i++) {
                const gap = sorted[i + 1].position - sorted[i].position;
                if (gap > maxGap) {
                    maxGap = gap;
                    gapPosition = sorted[i].position + gap / 2;
                }
            }
            
            // Calculate contrasting hue
            let newHue = (centerBarColors.reduce((sum, c) => sum + c.hue, 0) / centerBarColors.length + 180) % 360;
            
            centerBarColors.push({ position: gapPosition, hue: newHue });
            selectedMarkerIndex = centerBarColors.length - 1;
            renderMarkers();
            updateGradientPreview();
            updateMarkerHuePicker();
        });

        // Brightness toggle
        const brightnessToggle = document.getElementById('brightnessToggle');
        brightnessToggle.addEventListener('click', (e) => {
            if (e.target.classList.contains('toggle-option')) {
                document.querySelectorAll('#brightnessToggle .toggle-option').forEach(btn => {
                    btn.classList.remove('active');
                });
                e.target.classList.add('active');
                brightness = parseInt(e.target.dataset.value);
            }
        });

        // Effect on/off
        const effectOnBtn = document.getElementById('effectOn');
        const blackoutBtn = document.getElementById('blackout');

        effectOnBtn.addEventListener('click', () => {
            effectOn = true;
            effectOnBtn.classList.add('active');
            blackoutBtn.classList.remove('active');
        });

        blackoutBtn.addEventListener('click', () => {
            effectOn = false;
            blackoutBtn.classList.add('active');
            effectOnBtn.classList.remove('active');
        });

        // Firmware file handler
        document.getElementById('firmwareFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                console.log('Firmware file selected:', file.name);
            }
        });

        // Initialize
        function init() {
            initPageNav();
            initEffectsGrid();
            updateStaffVisual();
            updateStatus();
            initHeadTailHueSlider();
            initMarkerHueSlider();
            renderMarkers();
            updateGradientPreview();
            updateMarkerHuePicker();
            animate();
        }

        // Cleanup on page hide
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                cancelAnimationFrame(animationFrame);
            } else {
                animate();
            }
        });

        // Start
        init();
    </script>
</body>
</html>
